<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ãƒªãƒ¼ãƒãƒ³ãƒ‰ç—…å¤‰ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .left-panel {
            width: 300px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            height: fit-content;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .main-panel {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .file-input {
            margin-bottom: 20px;
            padding: 10px;
            border: 2px dashed #3498db;
            border-radius: 5px;
            text-align: center;
        }
        
        .disease-selector {
            margin-bottom: 20px;
        }
        
        .disease-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .disease-btn {
            padding: 12px;
            border: 2px solid #ddd;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .disease-btn:hover {
            background: #e9ecef;
        }
        
        .disease-btn.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .tools {
            margin-bottom: 20px;
        }
        
        .tool-btn {
            margin: 5px;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .tool-btn.active {
            background: #e74c3c;
            color: white;
        }
        
        .tool-btn.draw {
            background: #27ae60;
            color: white;
        }
        
        .tool-btn.erase {
            background: #f39c12;
            color: white;
        }
        
        .tool-btn.clear {
            background: #e74c3c;
            color: white;
        }
        
        .canvas-container {
            position: relative;
            display: inline-block;
            border: 3px solid #34495e;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        canvas {
            display: block;
            cursor: crosshair;
        }
        
        .info-panel {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .lesion-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        
        .lesion-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 3px;
            border-left: 4px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .export-section {
            margin-top: 20px;
            padding: 15px;
            background: #d5f4e6;
            border-radius: 5px;
        }
        
        .export-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        .progress {
            margin-top: 10px;
            padding: 10px;
            background: #3498db;
            color: white;
            border-radius: 5px;
            text-align: center;
        }
        
        .brush-size {
            margin: 10px 0;
        }
        
        .size-slider {
            width: 100%;
            margin: 5px 0;
        }
        
        .color-picker {
            margin: 10px 0;
        }
        
        .color-btn {
            width: 30px;
            height: 30px;
            border: 2px solid #333;
            margin: 2px;
            cursor: pointer;
            display: inline-block;
            border-radius: 50%;
        }
        
        .instructions {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¯ ãƒ•ãƒªãƒ¼ãƒãƒ³ãƒ‰ç—…å¤‰ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«</h1>
        <p>ãƒã‚¹ã‚¯æ¸ˆã¿åŒ»ç™‚ç”»åƒä¸Šã§ç—…å¤‰é ˜åŸŸã‚’ãƒ•ãƒªãƒ¼ãƒãƒ³ãƒ‰ã§é¸æŠã—ã€YOLOå­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ</p>
    </div>

    <div class="container">
        <div class="left-panel">
            <div class="file-input">
                <label for="imageInput">ğŸ“ ç”»åƒã‚’é¸æŠ</label>
                <input type="file" id="imageInput" accept="image/*" style="display:none;">
                <label for="folderInput">ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</label>
                <input type="file" id="folderInput" webkitdirectory multiple style="display:none;">
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    JPG, PNG, BMPå½¢å¼å¯¾å¿œ
                </div>
            </div>

            <div class="navigation-controls" style="margin-bottom: 20px;">
                <button class="tool-btn" id="prevImage" style="background: #9b59b6; color: white;">â† å‰ã®ç”»åƒ</button>
                <button class="tool-btn" id="nextImage" style="background: #9b59b6; color: white;">æ¬¡ã®ç”»åƒ â†’</button>
                <div style="margin-top: 10px; text-align: center; font-size: 14px;" id="imageProgress">
                    ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“
                </div>
            </div>

            <div class="disease-selector">
                <h3>ğŸ·ï¸ ç—…å¤‰ã‚¿ã‚¤ãƒ—é¸æŠ</h3>
                <div class="disease-buttons">
                    <div class="disease-btn active" data-disease="Melasma">è‚æ–‘ (Melasma)</div>
                    <div class="disease-btn" data-disease="Solar lentigo">æ—¥å…‰æ€§è‰²ç´ æ–‘ (Solar lentigo)</div>
                    <div class="disease-btn" data-disease="Nevus">æ¯æ–‘ (Nevus)</div>
                    <div class="disease-btn" data-disease="ADM">å¾Œå¤©æ€§çœŸçš®ãƒ¡ãƒ©ãƒã‚µã‚¤ãƒˆãƒ¼ã‚·ã‚¹ (ADM)</div>
                    <div class="disease-btn" data-disease="Ephelis">é›€åµæ–‘ (Ephelis)</div>
                    <div class="disease-btn" data-disease="Seborrheic keratosis">è„‚æ¼æ€§è§’åŒ–ç—‡ (Seborrheic keratosis)</div>
                    <div class="disease-btn" data-disease="Basal cell carcinoma">åŸºåº•ç´°èƒç™Œ (Basal cell carcinoma)</div>
                    <div class="disease-btn" data-disease="Malignant melanoma">æ‚ªæ€§é»’è‰²è…« (Malignant melanoma)</div>
                </div>
            </div>

            <div class="tools">
                <h3>ğŸ–Œï¸ æç”»ãƒ„ãƒ¼ãƒ«</h3>
                <button class="tool-btn draw active" id="drawTool">ãƒ•ãƒªãƒ¼ãƒãƒ³ãƒ‰æç”»</button>
                <button class="tool-btn erase" id="eraseTool">æ¶ˆã—ã‚´ãƒ </button>
                <button class="tool-btn clear" id="clearTool">å…¨æ¶ˆå»</button>
                
                <div class="brush-size">
                    <label>ç­†ã®ã‚µã‚¤ã‚º: <span id="brushSizeValue">5</span>px</label>
                    <input type="range" class="size-slider" id="brushSize" min="1" max="50" value="5">
                </div>
                
                <div class="color-picker">
                    <label>è‰²é¸æŠ:</label><br>
                    <div class="color-btn" style="background: #e74c3c;" data-color="#e74c3c"></div>
                    <div class="color-btn" style="background: #3498db;" data-color="#3498db"></div>
                    <div class="color-btn" style="background: #27ae60;" data-color="#27ae60"></div>
                    <div class="color-btn" style="background: #f39c12;" data-color="#f39c12"></div>
                    <div class="color-btn" style="background: #9b59b6;" data-color="#9b59b6"></div>
                    <div class="color-btn" style="background: #1abc9c;" data-color="#1abc9c"></div>
                </div>
            </div>

            <div class="info-panel">
                <h4>ğŸ“Š ç¾åœ¨ã®ç”»åƒæƒ…å ±</h4>
                <div id="imageInfo">ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
            </div>

            <div class="lesion-list">
                <h4>ğŸ¯ é¸æŠæ¸ˆã¿ç—…å¤‰ãƒªã‚¹ãƒˆ</h4>
                <div id="lesionsList">
                    ç—…å¤‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“
                </div>
            </div>

            <div class="export-section">
                <h4>ğŸ’¾ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h4>
                <button class="export-btn" id="exportJson">ç¾åœ¨ç”»åƒã‚’JSONä¿å­˜</button>
                <button class="export-btn" id="exportYolo">ç¾åœ¨ç”»åƒã‚’YOLOä¿å­˜</button>
                <button class="export-btn" id="exportAllYolo">å…¨ç”»åƒã‚’YOLOä¸€æ‹¬ä¿å­˜</button>
                <button class="export-btn" id="checkSavedData" style="background: #9b59b6;">ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ç¢ºèª</button>
                <button class="export-btn" id="exportMask">ãƒã‚¹ã‚¯ç”»åƒä¿å­˜</button>
            </div>
        </div>

        <div class="main-panel">
            <div class="instructions">
                <h3>ğŸ“ ä½¿ç”¨æ–¹æ³•</h3>
                <ol>
                    <li><strong>ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ:</strong> ã€ŒğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã€ã§ organized_masked ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</li>
                    <li><strong>ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³:</strong> ã€Œâ†å‰ã®ç”»åƒã€ã€Œæ¬¡ã®ç”»åƒâ†’ã€ãƒœã‚¿ãƒ³ã§ç§»å‹•</li>
                    <li><strong>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ:</strong> çŸ¢å°ã‚­ãƒ¼ï¼ˆâ†â†’ï¼‰ã¾ãŸã¯ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ç”»åƒåˆ‡ã‚Šæ›¿ãˆ</li>
                    <li><strong>ç—…å¤‰ã‚¿ã‚¤ãƒ—:</strong> è©²å½“ã™ã‚‹ç—…å¤‰ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ</li>
                    <li><strong>ãƒ•ãƒªãƒ¼ãƒãƒ³ãƒ‰æç”»:</strong> ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°ã§ç—…å¤‰é ˜åŸŸã‚’å›²ã‚€</li>
                    <li><strong>è‡ªå‹•ä¿å­˜:</strong> ç”»åƒã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹éš›ã«è‡ªå‹•ã§ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜</li>
                    <li><strong>é€²æ—ç¢ºèª:</strong> å·¦ãƒ‘ãƒãƒ«ã§å‡¦ç†æ¸ˆã¿ç”»åƒæ•°ã‚’ç¢ºèª</li>
                </ol>
            </div>

            <div class="canvas-container">
                <canvas id="imageCanvas"></canvas>
                <canvas id="annotationCanvas"></canvas>
            </div>

            <div class="progress" id="progressInfo" style="display:none;">
                ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³é€²æ—: <span id="progressText">0/738</span> æšå®Œäº†
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        class LesionAnnotationTool {
            constructor() {
                this.imageCanvas = document.getElementById('imageCanvas');
                this.annotationCanvas = document.getElementById('annotationCanvas');
                this.imageCtx = this.imageCanvas.getContext('2d');
                this.annotationCtx = this.annotationCanvas.getContext('2d');
                
                this.currentImage = null;
                this.currentDisease = 'Melasma';
                this.currentTool = 'draw';
                this.isDrawing = false;
                this.brushSize = 5;
                this.currentColor = '#e74c3c';
                
                this.annotations = [];
                this.currentPath = [];
                
                // ãƒ•ã‚©ãƒ«ãƒ€å†…ç”»åƒç®¡ç†
                this.imageFiles = [];
                this.currentImageIndex = 0;
                this.processedImages = new Set(); // å‡¦ç†æ¸ˆã¿ç”»åƒã‚’è¨˜éŒ²
                
                this.initEventListeners();
                this.setupCanvas();
            }
            
            initEventListeners() {
                // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›
                document.getElementById('imageInput').addEventListener('change', (e) => {
                    this.loadImage(e.target.files[0]);
                });
                
                // ãƒ•ã‚©ãƒ«ãƒ€å…¥åŠ›
                document.getElementById('folderInput').addEventListener('change', (e) => {
                    this.loadFolder(e.target.files);
                });
                
                // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³
                document.querySelector('label[for="imageInput"]').addEventListener('click', () => {
                    document.getElementById('imageInput').click();
                });
                
                // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠãƒœã‚¿ãƒ³
                document.querySelector('label[for="folderInput"]').addEventListener('click', () => {
                    document.getElementById('folderInput').click();
                });
                
                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
                document.getElementById('prevImage').addEventListener('click', () => {
                    this.previousImage();
                });
                
                document.getElementById('nextImage').addEventListener('click', () => {
                    this.nextImage();
                });
                
                // ç—…å¤‰ã‚¿ã‚¤ãƒ—é¸æŠ
                document.querySelectorAll('.disease-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.disease-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentDisease = e.target.dataset.disease;
                    });
                });
                
                // ãƒ„ãƒ¼ãƒ«é¸æŠ
                document.getElementById('drawTool').addEventListener('click', () => {
                    this.setTool('draw');
                });
                
                document.getElementById('eraseTool').addEventListener('click', () => {
                    this.setTool('erase');
                });
                
                document.getElementById('clearTool').addEventListener('click', () => {
                    this.clearAll();
                });
                
                // ãƒ–ãƒ©ã‚·ã‚µã‚¤ã‚º
                document.getElementById('brushSize').addEventListener('input', (e) => {
                    this.brushSize = parseInt(e.target.value);
                    document.getElementById('brushSizeValue').textContent = this.brushSize;
                });
                
                // è‰²é¸æŠ
                document.querySelectorAll('.color-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.currentColor = e.target.dataset.color;
                        document.querySelectorAll('.color-btn').forEach(b => b.style.border = '2px solid #333');
                        e.target.style.border = '4px solid #333';
                    });
                });
                
                // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                document.getElementById('exportJson').addEventListener('click', () => {
                    this.exportJSON();
                });
                
                document.getElementById('exportYolo').addEventListener('click', () => {
                    this.exportYOLO();
                });
                
                document.getElementById('exportMask').addEventListener('click', () => {
                    this.exportMask();
                });
                
                document.getElementById('exportAllYolo').addEventListener('click', () => {
                    this.exportAllYolo();
                });
                
                document.getElementById('checkSavedData').addEventListener('click', () => {
                    this.checkSavedData();
                });
                
                // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowRight' || e.key === ' ') {
                        e.preventDefault();
                        this.nextImage();
                    } else if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        this.previousImage();
                    }
                });
            }
            
            setupCanvas() {
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ä½ç½®ã‚’åˆã‚ã›ã‚‹
                this.annotationCanvas.style.position = 'absolute';
                this.annotationCanvas.style.top = '0';
                this.annotationCanvas.style.left = '0';
                this.annotationCanvas.style.pointerEvents = 'auto';
                
                // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
                this.annotationCanvas.addEventListener('mousedown', (e) => {
                    if (!this.currentImage) return;
                    this.startDrawing(e);
                });
                
                this.annotationCanvas.addEventListener('mousemove', (e) => {
                    if (!this.currentImage || !this.isDrawing) return;
                    this.draw(e);
                });
                
                this.annotationCanvas.addEventListener('mouseup', () => {
                    this.stopDrawing();
                });
                
                this.annotationCanvas.addEventListener('mouseout', () => {
                    this.stopDrawing();
                });
            }
            
            loadFolder(files) {
                // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                this.imageFiles = Array.from(files).filter(file => 
                    file.type.startsWith('image/')
                ).sort((a, b) => a.name.localeCompare(b.name));
                
                if (this.imageFiles.length === 0) {
                    alert('ãƒ•ã‚©ãƒ«ãƒ€å†…ã«ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                this.currentImageIndex = 0;
                this.loadCurrentImage();
                this.updateProgress();
                
                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                document.getElementById('prevImage').disabled = false;
                document.getElementById('nextImage').disabled = false;
            }
            
            loadImage(file) {
                if (!file) return;
                
                // å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯ãƒªã‚¹ãƒˆã‚’ä½œæˆ
                if (!this.imageFiles.length || !this.imageFiles.includes(file)) {
                    this.imageFiles = [file];
                    this.currentImageIndex = 0;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        this.currentImage = img;
                        this.currentFile = file;
                        this.setupCanvasSize(img);
                        this.drawImage();
                        this.updateImageInfo(file);
                        this.loadExistingAnnotations();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            loadCurrentImage() {
                if (this.imageFiles.length === 0) return;
                
                const currentFile = this.imageFiles[this.currentImageIndex];
                this.loadImage(currentFile);
            }
            
            previousImage() {
                if (this.imageFiles.length === 0) return;
                
                // ç¾åœ¨ã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•ä¿å­˜
                this.autoSaveAnnotations();
                
                this.currentImageIndex = Math.max(0, this.currentImageIndex - 1);
                this.loadCurrentImage();
                this.updateProgress();
            }
            
            nextImage() {
                if (this.imageFiles.length === 0) return;
                
                // ç¾åœ¨ã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•ä¿å­˜
                this.autoSaveAnnotations();
                
                this.currentImageIndex = Math.min(this.imageFiles.length - 1, this.currentImageIndex + 1);
                this.loadCurrentImage();
                this.updateProgress();
            }
            
            updateProgress() {
                if (this.imageFiles.length === 0) return;
                
                const progressText = `${this.currentImageIndex + 1} / ${this.imageFiles.length} æš`;
                const processedCount = this.processedImages.size;
                const progressInfo = `${progressText} (ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ¸ˆã¿: ${processedCount})`;
                
                document.getElementById('imageProgress').textContent = progressInfo;
                
                // é€²æ—ãƒãƒ¼ã‚’è¡¨ç¤º/æ›´æ–°
                const progressElement = document.getElementById('progressInfo');
                progressElement.style.display = 'block';
                document.getElementById('progressText').textContent = `${processedCount}/${this.imageFiles.length}`;
            }
            
            autoSaveAnnotations() {
                if (this.annotations.length > 0 && this.currentFile) {
                    const saveData = {
                        fileName: this.currentFile.name,
                        annotations: this.annotations,
                        timestamp: new Date().toISOString()
                    };
                    
                    try {
                        localStorage.setItem(`annotation_${this.currentFile.name}`, JSON.stringify(saveData));
                        this.processedImages.add(this.currentFile.name);
                        console.log(`ä¿å­˜å®Œäº†: ${this.currentFile.name}`);
                    } catch (e) {
                        console.warn(`ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${e.message}`);
                        alert(`ä¿å­˜å®¹é‡ã‚¨ãƒ©ãƒ¼ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„ã€‚`);
                    }
                }
            }
            
            loadExistingAnnotations() {
                if (!this.currentFile) return;
                
                // æ—¢å­˜ã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿
                const savedData = localStorage.getItem(`annotation_${this.currentFile.name}`);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    this.annotations = data.annotations || [];
                    this.redrawAnnotations();
                    this.updateLesionsList();
                    this.processedImages.add(this.currentFile.name);
                } else {
                    this.annotations = [];
                    this.annotationCtx.clearRect(0, 0, this.annotationCanvas.width, this.annotationCanvas.height);
                    this.updateLesionsList();
                }
            }
            
            setupCanvasSize(img) {
                const maxWidth = 700;
                const maxHeight = 500;
                
                let width = img.width;
                let height = img.height;
                
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                if (height > maxHeight) {
                    width = (width * maxHeight) / height;
                    height = maxHeight;
                }
                
                this.imageCanvas.width = width;
                this.imageCanvas.height = height;
                this.annotationCanvas.width = width;
                this.annotationCanvas.height = height;
                
                this.scaleX = img.width / width;
                this.scaleY = img.height / height;
            }
            
            drawImage() {
                if (!this.currentImage) return;
                
                this.imageCtx.clearRect(0, 0, this.imageCanvas.width, this.imageCanvas.height);
                this.imageCtx.drawImage(
                    this.currentImage,
                    0, 0,
                    this.imageCanvas.width,
                    this.imageCanvas.height
                );
            }
            
            setTool(tool) {
                this.currentTool = tool;
                
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                if (tool === 'draw') {
                    document.getElementById('drawTool').classList.add('active');
                    this.annotationCanvas.style.cursor = 'crosshair';
                } else if (tool === 'erase') {
                    document.getElementById('eraseTool').classList.add('active');
                    this.annotationCanvas.style.cursor = 'grab';
                }
            }
            
            getMousePos(e) {
                const rect = this.annotationCanvas.getBoundingClientRect();
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }
            
            startDrawing(e) {
                this.isDrawing = true;
                const pos = this.getMousePos(e);
                
                if (this.currentTool === 'draw') {
                    this.currentPath = [{
                        x: pos.x,
                        y: pos.y,
                        disease: this.currentDisease,
                        color: this.currentColor
                    }];
                }
            }
            
            draw(e) {
                if (!this.isDrawing) return;
                
                const pos = this.getMousePos(e);
                
                if (this.currentTool === 'draw') {
                    // ãƒ•ãƒªãƒ¼ãƒãƒ³ãƒ‰æç”»
                    this.annotationCtx.globalCompositeOperation = 'source-over';
                    this.annotationCtx.strokeStyle = this.currentColor;
                    this.annotationCtx.lineWidth = this.brushSize;
                    this.annotationCtx.lineCap = 'round';
                    this.annotationCtx.lineJoin = 'round';
                    
                    this.annotationCtx.beginPath();
                    const lastPoint = this.currentPath[this.currentPath.length - 1];
                    this.annotationCtx.moveTo(lastPoint.x, lastPoint.y);
                    this.annotationCtx.lineTo(pos.x, pos.y);
                    this.annotationCtx.stroke();
                    
                    this.currentPath.push({
                        x: pos.x,
                        y: pos.y,
                        disease: this.currentDisease,
                        color: this.currentColor
                    });
                    
                } else if (this.currentTool === 'erase') {
                    // æ¶ˆã—ã‚´ãƒ 
                    this.annotationCtx.globalCompositeOperation = 'destination-out';
                    this.annotationCtx.beginPath();
                    this.annotationCtx.arc(pos.x, pos.y, this.brushSize, 0, Math.PI * 2);
                    this.annotationCtx.fill();
                }
            }
            
            stopDrawing() {
                if (this.isDrawing && this.currentTool === 'draw' && this.currentPath.length > 0) {
                    // ãƒ‘ã‚¹ã‚’ä¿å­˜
                    this.annotations.push({
                        id: Date.now(),
                        disease: this.currentDisease,
                        color: this.currentColor,
                        path: [...this.currentPath],
                        timestamp: new Date().toISOString()
                    });
                    
                    this.updateLesionsList();
                }
                
                this.isDrawing = false;
                this.currentPath = [];
            }
            
            clearAll() {
                this.annotationCtx.clearRect(0, 0, this.annotationCanvas.width, this.annotationCanvas.height);
                this.annotations = [];
                this.updateLesionsList();
            }
            
            updateImageInfo(file) {
                const info = `
                    <strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${file.name}<br>
                    <strong>ã‚µã‚¤ã‚º:</strong> ${(file.size / 1024).toFixed(1)} KB<br>
                    <strong>è§£åƒåº¦:</strong> ${this.currentImage.width} Ã— ${this.currentImage.height}<br>
                    <strong>è¡¨ç¤ºã‚µã‚¤ã‚º:</strong> ${this.imageCanvas.width} Ã— ${this.imageCanvas.height}
                `;
                document.getElementById('imageInfo').innerHTML = info;
            }
            
            updateLesionsList() {
                const listElement = document.getElementById('lesionsList');
                
                if (this.annotations.length === 0) {
                    listElement.innerHTML = 'ç—…å¤‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“';
                    return;
                }
                
                const listHTML = this.annotations.map((annotation, index) => `
                    <div class="lesion-item">
                        <div>
                            <div style="color: ${annotation.color};">â— ${annotation.disease}</div>
                            <div style="font-size: 12px; color: #666;">
                                ãƒã‚¤ãƒ³ãƒˆæ•°: ${annotation.path.length}
                            </div>
                        </div>
                        <button class="delete-btn" onclick="annotationTool.deleteLesion(${annotation.id})">å‰Šé™¤</button>
                    </div>
                `).join('');
                
                listElement.innerHTML = listHTML;
            }
            
            deleteLesion(id) {
                this.annotations = this.annotations.filter(a => a.id !== id);
                this.redrawAnnotations();
                this.updateLesionsList();
            }
            
            redrawAnnotations() {
                this.annotationCtx.clearRect(0, 0, this.annotationCanvas.width, this.annotationCanvas.height);
                
                this.annotations.forEach(annotation => {
                    if (annotation.path.length < 2) return;
                    
                    this.annotationCtx.strokeStyle = annotation.color;
                    this.annotationCtx.lineWidth = this.brushSize;
                    this.annotationCtx.lineCap = 'round';
                    this.annotationCtx.lineJoin = 'round';
                    
                    this.annotationCtx.beginPath();
                    this.annotationCtx.moveTo(annotation.path[0].x, annotation.path[0].y);
                    
                    for (let i = 1; i < annotation.path.length; i++) {
                        this.annotationCtx.lineTo(annotation.path[i].x, annotation.path[i].y);
                    }
                    
                    this.annotationCtx.stroke();
                });
            }
            
            exportJSON() {
                if (this.annotations.length === 0) {
                    alert('ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                    return;
                }
                
                const exportData = {
                    image: {
                        width: this.currentImage.width,
                        height: this.currentImage.height,
                        displayWidth: this.imageCanvas.width,
                        displayHeight: this.imageCanvas.height
                    },
                    annotations: this.annotations.map(annotation => ({
                        id: annotation.id,
                        disease: annotation.disease,
                        color: annotation.color,
                        path: annotation.path.map(point => ({
                            x: Math.round(point.x * this.scaleX),
                            y: Math.round(point.y * this.scaleY)
                        })),
                        timestamp: annotation.timestamp
                    })),
                    exportTime: new Date().toISOString()
                };
                
                this.downloadFile(
                    JSON.stringify(exportData, null, 2),
                    'annotations.json',
                    'application/json'
                );
            }
            
            exportYOLO() {
                if (this.annotations.length === 0) {
                    alert('ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                    return;
                }
                
                // ç—…å¤‰ã‚¿ã‚¤ãƒ—ã®ã‚¯ãƒ©ã‚¹IDå®šç¾©
                const classMap = {
                    'Melasma': 0,
                    'Solar lentigo': 1,
                    'Nevus': 2,
                    'ADM': 3,
                    'Ephelis': 4,
                    'Seborrheic keratosis': 5,
                    'Basal cell carcinoma': 6,
                    'Malignant melanoma': 7
                };
                
                let yoloData = '';
                
                this.annotations.forEach(annotation => {
                    if (annotation.path.length < 3) return; // æœ€ä½3ç‚¹å¿…è¦
                    
                    const classId = classMap[annotation.disease] || 0;
                    
                    // ãƒ•ãƒªãƒ¼ãƒãƒ³ãƒ‰ãƒ‘ã‚¹ã‹ã‚‰ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
                    const realPath = annotation.path.map(point => ({
                        x: point.x * this.scaleX,
                        y: point.y * this.scaleY
                    }));
                    
                    const xs = realPath.map(p => p.x);
                    const ys = realPath.map(p => p.y);
                    
                    const minX = Math.min(...xs);
                    const maxX = Math.max(...xs);
                    const minY = Math.min(...ys);
                    const maxY = Math.max(...ys);
                    
                    const centerX = (minX + maxX) / 2 / this.currentImage.width;
                    const centerY = (minY + maxY) / 2 / this.currentImage.height;
                    const width = (maxX - minX) / this.currentImage.width;
                    const height = (maxY - minY) / this.currentImage.height;
                    
                    yoloData += `${classId} ${centerX.toFixed(6)} ${centerY.toFixed(6)} ${width.toFixed(6)} ${height.toFixed(6)}\n`;
                });
                
                this.downloadFile(yoloData, 'annotations.txt', 'text/plain');
            }
            
            exportMask() {
                if (this.annotations.length === 0) {
                    alert('ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                    return;
                }
                
                // ãƒã‚¹ã‚¯ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆ
                const maskCanvas = document.createElement('canvas');
                maskCanvas.width = this.currentImage.width;
                maskCanvas.height = this.currentImage.height;
                const maskCtx = maskCanvas.getContext('2d');
                
                // é»’èƒŒæ™¯
                maskCtx.fillStyle = '#000000';
                maskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);
                
                // ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³é ˜åŸŸã‚’ç™½ã§æç”»
                this.annotations.forEach(annotation => {
                    if (annotation.path.length < 3) return;
                    
                    maskCtx.fillStyle = '#FFFFFF';
                    maskCtx.beginPath();
                    
                    const firstPoint = annotation.path[0];
                    maskCtx.moveTo(firstPoint.x * this.scaleX, firstPoint.y * this.scaleY);
                    
                    for (let i = 1; i < annotation.path.length; i++) {
                        const point = annotation.path[i];
                        maskCtx.lineTo(point.x * this.scaleX, point.y * this.scaleY);
                    }
                    
                    maskCtx.closePath();
                    maskCtx.fill();
                });
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                maskCanvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'lesion_mask.png';
                    a.click();
                    URL.revokeObjectURL(url);
                });
            }
            
            checkSavedData() {
                const savedKeys = Object.keys(localStorage).filter(key => key.startsWith('annotation_'));
                const savedCount = savedKeys.length;
                
                if (savedCount === 0) {
                    alert('ä¿å­˜æ¸ˆã¿ã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                    return;
                }
                
                let report = `=== ä¿å­˜æ¸ˆã¿ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ ===\n`;
                report += `ç·æ•°: ${savedCount}ä»¶\n\n`;
                
                savedKeys.slice(0, 10).forEach(key => {
                    const fileName = key.replace('annotation_', '');
                    const data = JSON.parse(localStorage.getItem(key));
                    const annotationCount = data.annotations ? data.annotations.length : 0;
                    report += `ğŸ“ ${fileName}: ${annotationCount}å€‹ã®ç—…å¤‰\n`;
                });
                
                if (savedCount > 10) {
                    report += `\n... ä»–${savedCount - 10}ä»¶`;
                }
                
                report += `\n\nğŸ’¡ ã“ã‚Œã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¿®æ­£ç‰ˆãƒ„ãƒ¼ãƒ«ã§ã‚‚ä½¿ç”¨ã§ãã¾ã™ã€‚`;
                
                alert(report);
                console.log('ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿è©³ç´°:', savedKeys.map(key => ({
                    fileName: key.replace('annotation_', ''),
                    data: JSON.parse(localStorage.getItem(key))
                })));
            }
            
            exportAllYolo() {
                if (this.processedImages.size === 0) {
                    alert('ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ¸ˆã¿ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const zip = new JSZip();
                const classMap = {
                    'Melasma': 0,
                    'Solar lentigo': 1,
                    'Nevus': 2,
                    'ADM': 3,
                    'Ephelis': 4,
                    'Seborrheic keratosis': 5,
                    'Basal cell carcinoma': 6,
                    'Malignant melanoma': 7
                };
                
                // ã‚¯ãƒ©ã‚¹åãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
                const classNames = Object.keys(classMap).join('\n');
                zip.file('classes.txt', classNames);
                
                let totalExported = 0;
                
                // å„ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ¸ˆã¿ç”»åƒã®YOLOãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
                this.processedImages.forEach(fileName => {
                    const savedData = localStorage.getItem(`annotation_${fileName}`);
                    if (!savedData) return;
                    
                    const data = JSON.parse(savedData);
                    if (!data.annotations || data.annotations.length === 0) return;
                    
                    let yoloData = '';
                    data.annotations.forEach(annotation => {
                        if (annotation.path.length < 3) return;
                        
                        const classId = classMap[annotation.disease] || 0;
                        
                        // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¨ˆç®—ï¼ˆå®Ÿç”»åƒã‚µã‚¤ã‚ºãƒ™ãƒ¼ã‚¹ï¼‰
                        const xs = annotation.path.map(p => p.x);
                        const ys = annotation.path.map(p => p.y);
                        
                        const minX = Math.min(...xs);
                        const maxX = Math.max(...xs);
                        const minY = Math.min(...ys);
                        const maxY = Math.max(...ys);
                        
                        // ç”»åƒã‚µã‚¤ã‚ºã¯ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
                        const imgWidth = 800; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µã‚¤ã‚ºï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯æ­£ç¢ºãªã‚µã‚¤ã‚ºã‚’å–å¾—ï¼‰
                        const imgHeight = 600;
                        
                        const centerX = (minX + maxX) / 2 / imgWidth;
                        const centerY = (minY + maxY) / 2 / imgHeight;
                        const width = (maxX - minX) / imgWidth;
                        const height = (maxY - minY) / imgHeight;
                        
                        yoloData += `${classId} ${centerX.toFixed(6)} ${centerY.toFixed(6)} ${width.toFixed(6)} ${height.toFixed(6)}\n`;
                    });
                    
                    if (yoloData) {
                        const txtFileName = fileName.replace(/\.[^/.]+$/, '.txt');
                        zip.file(txtFileName, yoloData);
                        totalExported++;
                    }
                });
                
                if (totalExported === 0) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯èƒ½ãªã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                zip.generateAsync({type: 'blob'}).then(content => {
                    const url = URL.createObjectURL(content);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `yolo_annotations_${totalExported}files_${new Date().toISOString().slice(0,10)}.zip`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    alert(`${totalExported}æšã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’YOLOå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
                });
            }
            
            downloadFile(content, filename, contentType) {
                const blob = new Blob([content], { type: contentType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }
        }
        
        // åˆæœŸåŒ–
        const annotationTool = new LesionAnnotationTool();
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚µãƒãƒ¼ãƒˆ
        document.addEventListener('DragOver', (e) => {
            e.preventDefault();
        });
        
        document.addEventListener('drop', (e) => {
            e.preventDefault();
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                annotationTool.loadImage(files[0]);
            }
        });
    </script>
</body>
</html>