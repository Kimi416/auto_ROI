# 病変アノテーション・学習システム

T字マスク処理後の医用画像から病変を検出するYOLOv8システムです。

## システム概要

### 完了済みタスク
- ✅ T字マスク処理: 873枚完了 (100%)
- ✅ 手動病変アノテーション: 873枚完了 (100%)
- ✅ YOLOv8学習: 50エポック完了
- ✅ 精度評価: mAP50 48.7%達成

## ファイル構成

### アノテーションツール
- `annotation_tool_stable.py` - 安定版アノテーションツール（8病変タイプ対応）
- `annotation_tool_python.py` - OpenCV版アノテーションツール

### YOLO学習システム
- `yolo_trainer.py` - 包括的なYOLOv8学習システム
- `train_yolo_simple.py` - シンプルな学習スクリプト
- `train_to_50.py` - 50エポック学習用
- `test_model.py` - モデル評価・テストスクリプト

### データ
- `yolo_annotations/labels/` - YOLO形式ラベルファイル（402ファイル）
- `yolo_annotations/progress.json` - アノテーション進捗
- `yolo_dataset/dataset.yaml` - YOLO学習設定
- `evaluation_report.json` - 精度評価レポート

## 使用方法

### 1. アノテーション実行
```bash
python3 annotation_tool_stable.py organized_masked -o yolo_annotations
```

機能:
- 8病変タイプ対応（肝斑、日光性色素斑、母斑、ADM、雀卵斑、脂漏性角化症、基底細胞癌、悪性黒色腫）
- フリーハンド描画
- 自動進捗保存
- ファイル名表示

### 2. YOLO学習実行
```bash
python3 train_yolo_simple.py
```

設定:
- エポック数: 100（デフォルト）
- バッチサイズ: 4
- 画像サイズ: 640x640
- モデル: YOLOv8n (nano)

### 3. モデル評価
```bash
python3 test_model.py
```

出力:
- バリデーション・テスト精度
- 病変タイプ別精度
- サンプル画像での検出テスト
- 詳細評価レポート

## 学習結果

### 全体精度 (50エポック)
- **mAP50: 48.7%** (5倍向上)
- **mAP50-95: 28.5%** (8倍向上)
- **Precision: 53.9%**
- **Recall: 44.7%**

### 病変タイプ別精度
| 病変タイプ | mAP50 | 評価 |
|-----------|-------|------|
| 雀卵斑 (Ephelis) | 99.5% | 🥇 |
| 脂漏性角化症 | 99.5% | 🥇 |
| 肝斑 (Melasma) | 68.9% | 🥈 |
| ADM | 23.8% | ⚠️ |
| 日光性色素斑 | 14.5% | ⚠️ |
| 基底細胞癌 | 4.1% | ⚠️ |

### データセット分割
- **Training**: 282枚 (70%)
- **Validation**: 80枚 (20%)
- **Test**: 40枚 (10%)

## モデル仕様

- **アーキテクチャ**: YOLOv8n
- **パラメータ数**: 3,007,208
- **モデルサイズ**: 6.2MB
- **推論速度**: ~27ms/画像 (CPU)
- **入力サイズ**: 640x640

## 改善の提案

1. **低精度病変タイプの改善**:
   - データ拡張 (Data Augmentation)
   - より多くのアノテーションデータ
   - クラス重み調整

2. **モデル性能向上**:
   - YOLOv8s/mモデルの使用
   - より長期間の学習 (100+ エポック)
   - GPUを使用した高速学習

3. **実用化に向けて**:
   - 医師による検証
   - 臨床データでの評価
   - ユーザーインターフェース開発

## システム要件

- Python 3.8+
- ultralytics (YOLOv8)
- OpenCV
- NumPy
- PyYAML

## 注意事項

- 本システムは研究・教育目的での使用を想定
- 医療診断には使用しないでください
- 実際の医療現場での使用には医師の監督が必要